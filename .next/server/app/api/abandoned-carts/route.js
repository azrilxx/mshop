"use strict";(()=>{var t={};t.id=369,t.ids=[369],t.modules={2934:t=>{t.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:t=>{t.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:t=>{t.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:t=>{t.exports=require("crypto")},7147:t=>{t.exports=require("fs")},3685:t=>{t.exports=require("http")},5687:t=>{t.exports=require("https")},5477:t=>{t.exports=require("punycode")},2781:t=>{t.exports=require("stream")},7310:t=>{t.exports=require("url")},9796:t=>{t.exports=require("zlib")},3713:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var r={};a.r(r),a.d(r,{GET:()=>l,PATCH:()=>w,POST:()=>c});var n=a(9303),i=a(8716),s=a(670),o=a(7070),d=a(9487),u=a(9178);async function l(t){try{await (0,u.MH)(["admin"]);let t=await d.Zd.getAbandonedCarts(),e=await Promise.all(t.map(async({userId:t,cart:e})=>{let a=await d.ut.findByEmail(t);return{userId:t,user:a?{email:a.email,role:a.role}:null,cart:e,itemCount:e.items.length,lastUpdated:e.updatedAt}}));return o.NextResponse.json(e)}catch(t){return o.NextResponse.json({error:t.message||"Failed to fetch abandoned carts"},{status:500})}}async function c(t){try{await (0,u.MH)(["admin"]);let{userId:e,markReminderSent:a}=await t.json();if(!e||"boolean"!=typeof a)return o.NextResponse.json({error:"User ID and markReminderSent flag are required"},{status:400});let r=await d.Zd.get(e);return r.reminderSent=a,await d.Zd.update(e,r),o.NextResponse.json({message:"Cart reminder status updated"})}catch(t){return o.NextResponse.json({error:t.message||"Failed to update cart reminder status"},{status:500})}}async function w(t){try{let t=await d.Zd.getAbandonedCarts(),e=0;for(let{userId:a,cart:r}of t)r.reminderSent=!0,await d.Zd.update(a,r),e++;return o.NextResponse.json({message:`Processed ${e} abandoned cart reminders`,remindersSent:e})}catch(t){return o.NextResponse.json({error:t.message||"Failed to process abandoned cart reminders"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/abandoned-carts/route",pathname:"/api/abandoned-carts",filename:"route",bundlePath:"app/api/abandoned-carts/route"},resolvedPagePath:"/home/runner/workspace/app/api/abandoned-carts/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f}=p,y="/api/abandoned-carts/route";function h(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},9178:(t,e,a)=>{a.d(e,{Gg:()=>i,MH:()=>d,SO:()=>s,ed:()=>n,mk:()=>o});var r=a(1615);async function n(t){let e={user:t,expires:new Date(Date.now()+6048e5).toISOString()};(0,r.cookies)().set("session",JSON.stringify(e),{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800})}async function i(){let t=(0,r.cookies)().get("session");if(!t)return null;try{let e=JSON.parse(t.value);if(new Date(e.expires)<new Date)return await s(),null;return e}catch{return null}}async function s(){(0,r.cookies)().delete("session")}async function o(){let t=await i();if(!t)throw Error("Authentication required");return t.user}async function d(t){let e=await o();if(!t.includes(e.role))throw Error("Insufficient permissions");return e}},9487:(t,e,a)=>{a.d(e,{Kl:()=>f,SB:()=>m,Tb:()=>g,Up:()=>l,Yf:()=>p,Zd:()=>w,ir:()=>y,ut:()=>u,wQ:()=>c});var r=a(741),n=a.n(r),i=a(2023),s=a.n(i),o=a(9576);let d=new(n()),u={async create(t,e,a){if(await d.get(`user:${t}`))throw Error("User already exists");let r={id:(0,o.Z)(),email:t,passwordHash:await s().hash(e,10),role:a,is_verified:"admin"===a,createdAt:new Date().toISOString()};return await d.set(`user:${t}`,r),r},findByEmail:async t=>await d.get(`user:${t}`),async verifyPassword(t,e){let a=await this.findByEmail(t);return a&&await s().compare(e,a.passwordHash)?a:null},async updateVerificationStatus(t,e){let a=await this.findByEmail(t);a&&(a.is_verified=e,await d.set(`user:${t}`,a))},async getAll(){let t=await d.list("user:"),e=[];for(let a of t){let t=await d.get(a);t&&e.push(t)}return e},async findById(t){for(let e of(await d.list("user:"))){let a=await d.get(e);if(a&&a.id===t)return a}return null}},l={async create(t){let e={...t,id:(0,o.Z)(),createdAt:new Date().toISOString()};return await d.set(`product:${e.id}`,e),e},findById:async t=>await d.get(`product:${t}`),async findByMerchant(t){let e=await d.list("product:"),a=[];for(let r of e){let e=await d.get(r);e&&e.merchantId===t&&a.push(e)}return a},async getAll(){let t=await d.list("product:"),e=[];for(let a of t){let t=await d.get(a);if(t&&"active"===t.status){let a=await this.getMerchantById(t.merchantId);a&&a.is_verified&&e.push(t)}}return e},async getAllForPublic(){let t=await d.list("product:"),e=[];for(let a of t){let t=await d.get(a);if(t&&"active"===t.status){let a=await this.getMerchantById(t.merchantId);a&&a.is_verified&&e.push(t)}}return e},getMerchantById:async t=>await u.findById(t),async update(t,e){let a=await this.findById(t);if(!a)return null;let r={...a,...e};return await d.set(`product:${t}`,r),r}},c={async create(t){let e={...t,id:(0,o.Z)(),createdAt:new Date().toISOString()};return await d.set(`order:${e.id}`,e),e},findById:async t=>await d.get(`order:${t}`),async findByBuyer(t){let e=await d.list("order:"),a=[];for(let r of e){let e=await d.get(r);e&&e.buyerId===t&&a.push(e)}return a},async getAll(){let t=await d.list("order:"),e=[];for(let a of t){let t=await d.get(a);t&&e.push(t)}return e},async update(t,e){let a=await this.findById(t);if(!a)return null;let r={...a,...e};return await d.set(`order:${t}`,r),r},async findBySeller(t){let e=await d.list("order:"),a=[];for(let r of e){let e=await d.get(r);e&&(await Promise.all(e.productIds.map(t=>l.findById(t)))).some(e=>e&&e.merchantId===t)&&a.push(e)}return a}},w={get:async t=>await d.get(`cart:${t}`)||{items:[],updatedAt:new Date().toISOString()},async update(t,e){e.updatedAt=new Date().toISOString(),await d.set(`cart:${t}`,e)},async addItem(t,e,a=1){let r=await this.get(t),n=r.items.find(t=>t.productId===e);n?n.quantity+=a:r.items.push({productId:e,quantity:a}),await this.update(t,r)},async removeItem(t,e){let a=await this.get(t);a.items=a.items.filter(t=>t.productId!==e),await this.update(t,a)},async clear(t){await d.set(`cart:${t}`,{items:[],updatedAt:new Date().toISOString()})},async getAbandonedCarts(){let t=await d.list("cart:"),e=[],a=new Date(Date.now()-864e5);for(let r of t){let t=await d.get(r);if(t&&t.items.length>0&&!t.reminderSent&&new Date(t.updatedAt)<a){let a=r.replace("cart:","");e.push({userId:a,cart:t})}}return e}},p={async create(t,e="Free"){let a={userId:t,tier:e,...{Free:{maxProducts:20,maxAdSlots:0,customerSupport:!1},Standard:{maxProducts:60,maxAdSlots:12,customerSupport:!0},Premium:{maxProducts:-1,maxAdSlots:-1,customerSupport:!0}}[e],quotaUsed:0,adSlotsUsed:0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await d.set(`plan:${t}`,a),a},async get(t){return await d.get(`plan:${t}`)||await this.create(t,"Free")},async update(t,e){let a={...await this.get(t),...e,updatedAt:new Date().toISOString()};return await d.set(`plan:${t}`,a),a},async incrementQuota(t){let e=await this.get(t);e.quotaUsed+=1,await this.update(t,{quotaUsed:e.quotaUsed})},async decrementQuota(t){let e=await this.get(t);e.quotaUsed>0&&(e.quotaUsed-=1,await this.update(t,{quotaUsed:e.quotaUsed}))}},g={async create(t){let e={...t,id:(0,o.Z)(),createdAt:new Date().toISOString()};return await d.set(`ad:${e.id}`,e),e},findById:async t=>await d.get(`ad:${t}`),async findBySeller(t){let e=await d.list("ad:"),a=[];for(let r of e){let e=await d.get(r);e&&e.sellerId===t&&a.push(e)}return a},async getActiveAds(){let t=await d.list("ad:"),e=[],a=new Date;for(let r of t){let t=await d.get(r);t&&"active"===t.status&&new Date(t.activeFrom)<=a&&new Date(t.activeUntil)>=a&&e.push(t)}return e},async update(t,e){let a=await this.findById(t);if(!a)return null;let r={...a,...e};return await d.set(`ad:${t}`,r),r}},m={async create(t){let e={...t,status:"pending",submittedAt:new Date().toISOString()};return await d.set(`verification:${t.userId}`,e),e},get:async t=>await d.get(`verification:${t}`),async update(t,e){let a=await this.get(t);if(!a)return null;let r={...a,...e};return e.status&&"pending"!==e.status&&(r.reviewedAt=new Date().toISOString()),await d.set(`verification:${t}`,r),r},async getAll(){let t=await d.list("verification:"),e=[];for(let a of t){let t=await d.get(a);t&&e.push(t)}return e}},f={async create(t){let e={...t,createdAt:new Date().toISOString()};return await d.set(`rating:${t.productId}:${t.userId}`,e),e},get:async(t,e)=>await d.get(`rating:${t}:${e}`),async getByProduct(t){let e=await d.list(`rating:${t}:`),a=[];for(let t of e){let e=await d.get(t);e&&a.push(e)}return a},async getAverageRating(t){let e=await this.getByProduct(t);return 0===e.length?{average:0,count:0}:{average:Number((e.reduce((t,e)=>t+e.rating,0)/e.length).toFixed(1)),count:e.length}}},y={async create(t){let e={...t,id:(0,o.Z)(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await d.set(`comment:${e.id}`,e),e},async getByProduct(t){let e=await d.list("comment:"),a=[];for(let r of e){let e=await d.get(r);e&&e.productId===t&&a.push(e)}return a.sort((t,e)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime())},async getReplies(t){let e=await d.list("comment:"),a=[];for(let r of e){let e=await d.get(r);e&&e.parentId===t&&a.push(e)}return a.sort((t,e)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())},async update(t,e){let a=await d.get(`comment:${t}`);if(!a)return null;let r={...a,...e,updatedAt:new Date().toISOString()};return await d.set(`comment:${t}`,r),r},async delete(t){if(!await d.get(`comment:${t}`))return!1;for(let e of(await this.getReplies(t)))await d.delete(`comment:${e.id}`);return await d.delete(`comment:${t}`),!0}}}};var e=require("../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),r=e.X(0,[276,615,701,972],()=>a(3713));module.exports=r})();